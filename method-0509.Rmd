---
title: "method-0509.Rmd"
author: "Ji Hua"
date: "2016-05-09"
output: html_document
---
#GONet

##Preparation

###Library

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
```

###Read Data
```{r}
######### Read from excel################
data<-read.csv("expression.csv",header = TRUE)

data[is.na(data)]<-0

rownames(data)<-data[,1]
data<-data%>%select(-X)
```
###Calculate correlation
```{r}
############## Correlation Matrix ####################################
cormatrix <- cor(t(data), method = "pearson")
# Test out correlation
cormatrix.df<-tbl_df(as.data.frame(cormatrix))

rownames(cormatrix.df)<-colnames(cormatrix.df)%>%t()

cormatrix.df<-cormatrix.df%>%add_rownames()
colnames(cormatrix.df)[1]<-"plasmoId"
```

###Test different method
####aNN
```{r}
k<-10 ###set k=10
total_neighbors<-cormatrix.df[,1]
for(i in 2:length(cormatrix.df)){
  neighbors<-cormatrix.df[,c(1,i)]%>%top_n(k+1)
  total_neighbors<-left_join(total_neighbors,neighbors,by="plasmoId")
}

write.csv(total_neighbors,"neighbors.csv")
total_neighbors<-read.csv("neighbors.csv",header = TRUE)

total_neighbors<-total_neighbors%>%select(-X)
rownames(total_neighbors)<-total_neighbors[,1]
total_neighbors<-total_neighbors[,-1]

total_neighbors[!is.na(total_neighbors)]<-1
total_neighbors[is.na(total_neighbors)]<-0

```

```{r}
index <- which(total_neighbors==1, arr.ind=TRUE)
double_neighbors<-total_neighbors

for(i in 1:nrow(index)){
  col<-index[i,2]
  row<-index[i,1]
  if(total_neighbors[row,col]!=total_neighbors[col,row]){
    double_neighbors[row,col]<-0
    double_neighbors[col,row]<-0
  }
}

write.csv(double_neighbors,"mnn_neighbors.csv")


```


###Prepare GO terms

```{r}
################ Get Go data and wrangle  ############################
library("GO.db")
###Prepare GO terms
#MF: "GO:0003674"
#BP: "GO:0008150"
#CC: "GO:0005575"

mfRoot<-"GO:0003674"
bpRoot<-"GO:0008150"
ccRoot<-"GO:0005575"

GO_data<-read.csv("PasmoDBID_and_GO_unprocessed.csv",stringsAsFactors = FALSE)

mfChildren<-GOMFCHILDREN[[mfRoot]]
bpChildren<-GOBPCHILDREN[[bpRoot]]
ccChildren<-GOCCCHILDREN[[ccRoot]]
#nrow(GO_data)
GO_table<-data.frame(plasomDBID=character(0),GOTerm=character(0),GOAncestor=character(0),GOBranch=character(0))
for (j in 1:nrow(GO_data)){
  obs<-GO_data[j,]
  flag<-NULL
  if(!is.null(GOBPANCESTOR[[obs[1,2]]])){
    flag<-"bp"
    ancester<-GOBPANCESTOR[[obs[1,2]]]
    if(bpRoot== ancester[[1]]){
      obs<-cbind(obs,bpRoot,flag)
    }else{
      for(i in ancester){
        if (i %in% bpChildren){
          obs<-cbind(obs,as.vector(i),flag)
          break
        }
      }
    }
  }
  if(!is.null(GOCCANCESTOR[[obs[1,2]]])){
    flag<-"cc"
    ancester<-GOCCANCESTOR[[obs[1,2]]]
    if(ccRoot == ancester[[1]]){
      obs<-cbind(obs,ccRoot,flag)
    }else{
        for(i in ancester){
        if (i %in% ccChildren){
          obs<-cbind(obs,as.vector(i),flag)
          break
        }
      }
    }
  }
  if(!is.null(GOMFANCESTOR[[obs[1,2]]])){
    flag<-"mf"
    ancester<-GOMFANCESTOR[[obs[1,2]]]
    if(mfRoot == ancester[[1]]){
      obs<-cbind(obs,mfRoot,flag)
    }else{
      for(i in ancester){
        if (i %in% mfChildren){
          obs<-cbind(obs,as.vector(i),flag)
          break
        }
      }
    }
  }
  if(is.null(flag))
    next
  colnames(obs)<-c("plasomDBID","GOTerm","GOAncestor","GOBranch")
  GO_table<-rbind(GO_table,obs)
  print(j)
  
}


```

